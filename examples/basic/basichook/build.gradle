apply plugin: 'java'

buildscript {
  repositories {
    jcenter()
  }

  dependencies {
    classpath 'com.github.jengelman.gradle.plugins:shadow:+'
  }
}

apply plugin: 'com.github.johnrengelman.shadow'


class EmbeddedAgentPlugin implements Plugin<Project> {
  void apply(Project project) {

    project.task('embed') {
      doLast {
        def bbver = project.configurations.compileOnly.files.find { it.getName().startsWith("byte-buddy-")}.getParentFile().getParentFile().getName()
        def cvlver = project.configurations.compileOnly.files.find { it.getName().startsWith("caldum-")}.getParentFile().getParentFile().getName()

        project.configure(project) {
          apply plugin: 'com.github.johnrengelman.shadow'

          repositories {
            mavenLocal()
            mavenCentral()
          }

          configurations {
            lol {
              resolutionStrategy.failOnVersionConflict()
            }
          }

          dependencies {
            lol group: 'net.bytebuddy', name: 'byte-buddy', version: bbver
            lol group: 'trust.nccgroup', name: 'vulcanloader', version: cvlver
          }

        }

        // note: if this following line of code errors with a specific
        // conflicting version, the specified version of byte-buddy conflicts
        // with the range of versions allowed by the specified version of
        // caldum. gradle simply reports the highest version within that range.
        def vlJar = project.configurations.lol.files[0].toString()
        def agentJar = project.shadowJar.outputs.files[0].toString()
        def outJarName = new File(agentJar).getName().split('\\.')[0] + '-vl.jar'

        println project.configurations.lol.files
        println outJarName
        println vlJar
      }
    }
    project.tasks.embed.dependsOn(project.tasks.shadowJar)
  }
}

// Apply the plugin
apply plugin: EmbeddedAgentPlugin



sourceCompatibility = 1.6
targetCompatibility = 1.6

repositories {
  mavenLocal()
  mavenCentral()
}

dependencies {
  compile fileTree(include: ['*.jar'], dir: 'lib')

  compileOnly group: 'trust.nccgroup', name: 'caldum', version: '1.0.0'
  compileOnly group: 'net.bytebuddy', name: 'byte-buddy', version: '1.9.7'
}

sourceSets {
  main {
    java {
      srcDirs = ['./src']
    }

    resources {
      srcDirs = ['./res']
    }
  }
}

jar {
  manifest {
    attributes (
            "Manifest-Version": "1.0",
            "Premain-Class": "trust.nccgroup.basichook.AgentEntry",
            "Agent-Class": "trust.nccgroup.basichook.AgentEntry"
    )
  }
}


defaultTasks "shadowJar"
